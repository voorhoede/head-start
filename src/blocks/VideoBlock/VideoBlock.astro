---
import type { UploadVideoField, VideoBlockFragment } from '@lib/types/datocms';
import { getLocale, getLocaleName } from '@lib/i18n';

interface Props {
  block: VideoBlockFragment;
}
const { block } = Astro.props;
const { alt, width, height } = block.videoAsset;
const video = block.videoAsset.video as UploadVideoField;
const aspectRatio = width && height ? width / height : null;
const activeLocale = getLocale();
---

<video-block data-autoplay={ block.autoplay ? 'true' : 'false' }>
  <figure>
    <video
      poster={video.thumbnailUrl}
      controls
      crossorigin="anonymous"
      loop={block.loop ? 'true' : null}
      muted={block.mute ? 'true' : null}
      width={width}
      height={height}
      preload='none'
      style={{ aspectRatio }}
    >
      <source src={video.streamingUrl} type='application/vnd.apple.mpegurl' />
      <source src={video.streamingUrl} type='application/x-mpegURL' />
      <source src={video.mp4Url} type='video/mp4' />
      { block.tracks.map(track => (
        <track
          kind={track.kind}
          label={track.title || getLocaleName(track.locale) }
          src={track.file.url}
          srclang={track.locale}
          default={track.locale === activeLocale}
        />
      )) }
      {alt}
    </video>

    {block.title && <figcaption>{block.title}</figcaption>}
  </figure>
</video-block>

<script src="./VideoBlock.client.ts"></script>

<style>
  video {
    display: block;
    max-width: 100%;
    height: auto;
    object-fit: contain;
  }
</style>
