---
import type { GroupingBlockFragment } from '@lib/datocms/types';
import Blocks from '@blocks/Blocks.astro';
import { Accordion, AccordionItem } from '@components/Accordion';
import { Tabs, TabsTab, TabsPanel } from '@components/Tabs';

export interface Props {
  block: GroupingBlockFragment;
  fieldPath?: string;
}

const isLayout = (layout: GroupingBlockFragment['layout']) => block.layout === layout;

const { block, fieldPath } = Astro.props;
const items = block.items;

function buildNestedFieldPath(basePath: string, itemIndex: number): string {
  if (basePath.endsWith('.items')) {
    return `${basePath}.${itemIndex}.blocks`;
  }
  return `${basePath}.items.${itemIndex}.blocks`;
}
---
{ isLayout('stack-titled') && (
  items.map((item, itemIndex) => (
    <section>
      <h2>{ item.title }</h2>
      <Blocks
        blocks={ item.blocks }
        fieldPath={ fieldPath ? buildNestedFieldPath(fieldPath, itemIndex) : undefined }
      />
    </section>
  ))
)}

{ isLayout('stack-untitled') && (
  items.map((item, itemIndex) => (
    <Blocks
      blocks={ item.blocks }
      fieldPath={ fieldPath ? buildNestedFieldPath(fieldPath, itemIndex) : undefined }
    />
  ))
)}

{ (isLayout('accordion-open') || isLayout('accordion-closed')) && (
  <Accordion>
    { items.map((item, itemIndex) => (
      <AccordionItem
        name={ `block-${block.id}` }
        open={ isLayout('accordion-open') }
      >
        <Fragment slot="heading">{ item.title }</Fragment>
        <Fragment slot="body">
          <Blocks
            blocks={ item.blocks }
            fieldPath={ fieldPath ? buildNestedFieldPath(fieldPath, itemIndex) : undefined }
          />
        </Fragment>
      </AccordionItem>
    ))}
  </Accordion>
)}

{ isLayout('tabs') && (
  <Tabs>
    { items.map((item, itemIndex) => (<>
      <TabsTab>{ item.title }</TabsTab>
      <TabsPanel>
        <Blocks
          blocks={ item.blocks }
          fieldPath={ fieldPath ? buildNestedFieldPath(fieldPath, itemIndex) : undefined }
        />
      </TabsPanel>
    </>))}
  </Tabs>
)}
