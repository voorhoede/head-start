---
import { PUBLIC_IS_PRODUCTION } from 'astro:env/server';
import type { AnyBlock } from './Blocks';
import ActionBlock from './ActionBlock/ActionBlock.astro';
import EmbedBlock from './EmbedBlock/EmbedBlock.astro';
import ImageBlock from './ImageBlock/ImageBlock.astro';
import PagePartialBlock from './PagePartialBlock/PagePartialBlock.astro';
import TableBlock from './TableBlock/TableBlock.astro';
import TextBlock from './TextBlock/TextBlock.astro';
import TextImageBlock from './TextImageBlock/TextImageBlock.astro';
import VideoBlock from './VideoBlock/VideoBlock.astro';
import VideoEmbedBlock from './VideoEmbedBlock/VideoEmbedBlock.astro';
import GroupingBlock from './GroupingBlock/GroupingBlock.astro';
import { getEditorPaths } from './block-editor-utils';
import Icon from '~/components/Icon';

const blocksByTypename = {
  ActionBlockRecord: ActionBlock,
  EmbedBlockRecord: EmbedBlock,
  ImageBlockRecord: ImageBlock,
  PagePartialBlockRecord: PagePartialBlock,
  TableBlockRecord: TableBlock,
  TextBlockRecord: TextBlock,
  TextImageBlockRecord: TextImageBlock,
  VideoBlockRecord: VideoBlock,
  VideoEmbedBlockRecord: VideoEmbedBlock,
  GroupingBlockRecord: GroupingBlock,
};

interface Props {
  blocks: AnyBlock[];
  editorFieldPath?: string;
  hideEditorLabels?: boolean;
}
const { blocks, hideEditorLabels = false } = Astro.props;
const editorFieldPath = Astro.props.editorFieldPath ?? 'bodyBlocks';
const isPreview = Astro.locals.isPreview;

const raise = (message: string) => {
  if (!PUBLIC_IS_PRODUCTION) {
    console.error(message);
  }
  return message;
};
---

{
  blocks.map((block, index) => {
    const { __typename, ...rest } = block;
    if (!Object.keys(rest).length) {
      const message = raise(`No block data found for "${__typename}". Is the associated fragment included in the query?`);
      return <script define:vars={{ message }} is:inline>console.log(message);</script>;
    }
    const Block = blocksByTypename[__typename as keyof typeof blocksByTypename];
    if (!Block) {
      const message = raise(`No block data found for "${__typename}". Is it included in ${import.meta.filename}?`);
      return <script define:vars={{ message }} is:inline>console.log(message);</script>;
    }

    const { blockBasePath, blockFieldPath, blockName } = getEditorPaths(editorFieldPath, index, __typename);

    return (
      <>
        {isPreview && !hideEditorLabels && blockFieldPath && (
          /* eslint-disable-next-line astro/jsx-a11y/anchor-is-valid */
          <a
            class="block-name-label"
            data-editor-edit-block
            data-editor-field-path={blockFieldPath}
            data-editor-block-name={blockName}
            target="_blank"
          >
            {blockName} <Icon name="external" />
          </a>
        )}
        {/* @ts-expect-error - since block can be any block its type is conflated to `never`. */}
        <Block block={block} editorFieldPath={blockBasePath} hideEditorLabels={hideEditorLabels} />
      </>
    );
  })
}

