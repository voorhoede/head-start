---
import { PUBLIC_IS_PRODUCTION } from 'astro:env/server';
import type { AnyBlock } from './Blocks';
import ActionBlock from './ActionBlock/ActionBlock.astro';
import EmbedBlock from './EmbedBlock/EmbedBlock.astro';
import ImageBlock from './ImageBlock/ImageBlock.astro';
import PagePartialBlock from './PagePartialBlock/PagePartialBlock.astro';
import TableBlock from './TableBlock/TableBlock.astro';
import TextBlock from './TextBlock/TextBlock.astro';
import TextImageBlock from './TextImageBlock/TextImageBlock.astro';
import VideoBlock from './VideoBlock/VideoBlock.astro';
import VideoEmbedBlock from './VideoEmbedBlock/VideoEmbedBlock.astro';
import GroupingBlock from './GroupingBlock/GroupingBlock.astro';
import itemTypesJson from '@lib/datocms/itemTypes.json';

const blocksByTypename = {
  ActionBlockRecord: ActionBlock,
  EmbedBlockRecord: EmbedBlock,
  ImageBlockRecord: ImageBlock,
  PagePartialBlockRecord: PagePartialBlock,
  TableBlockRecord: TableBlock,
  TextBlockRecord: TextBlock,
  TextImageBlockRecord: TextImageBlock,
  VideoBlockRecord: VideoBlock,
  VideoEmbedBlockRecord: VideoEmbedBlock,
  GroupingBlockRecord: GroupingBlock,
};

interface Props {
  blocks: AnyBlock[];
  debugFieldPath?: string;
  hideDebugLabels?: boolean;
}
const { blocks, hideDebugLabels = false } = Astro.props;
const debugFieldPath = Astro.props.debugFieldPath === '' ? '' : (Astro.props.debugFieldPath ?? 'bodyBlocks');
const isPreview = Astro.locals.isPreview;

function camelToSnake(str: string): string {
  return str.replace(/[A-Z]/g, (letter) => `_${letter.toLowerCase()}`).replace(/^_/, '');
}

function toApiKey(debugFieldPath: string): string {
  if (debugFieldPath.includes('.')) {
    const parts = debugFieldPath.split('.');
    const rootField = parts[0];
    const rest = parts.slice(1).join('.');
    return `${camelToSnake(rootField)}.${rest}`;
  }
  return camelToSnake(debugFieldPath);
}

const itemTypes = (itemTypesJson as { itemTypes?: Record<string, { id: string; name: string; focusField?: string }> }).itemTypes;

function getItemTypeMeta(typename: string) {
  return itemTypes?.[typename];
}

function getFocusFieldApiKey(typename: string): string | null {
  return getItemTypeMeta(typename)?.focusField ?? null;
}

function getBlockDisplayName(typename: string): string {
  return getItemTypeMeta(typename)?.name ?? typename.replace(/Record$/, '');
}

const raise = (message: string) => {
  if (!PUBLIC_IS_PRODUCTION) {
    console.error(message);
  }
  return message;
};
---

{
  blocks.map((block, index) => {
    const { __typename, ...rest } = block;
    if (!Object.keys(rest).length) {
      const message = raise(`No block data found for "${__typename}". Is the associated fragment included in the query?`);
      return <script define:vars={{ message }} is:inline>console.log(message);</script>;
    }
    const Block = blocksByTypename[__typename as keyof typeof blocksByTypename];
    if (!Block) {
      const message = raise(`No block data found for "${__typename}". Is it included in ${import.meta.filename}?`);
      return <script define:vars={{ message }} is:inline>console.log(message);</script>;
    }
    const blockName = getBlockDisplayName(__typename);
    const focusFieldApiKey = getFocusFieldApiKey(__typename);
    const apiKeyPath = debugFieldPath && debugFieldPath !== '' ? toApiKey(debugFieldPath) : null;
    const blockBasePath = apiKeyPath ? `${apiKeyPath}.${index}` : null;
    const blockFieldPath = blockBasePath
      ? `${blockBasePath}${focusFieldApiKey ? `.${focusFieldApiKey}` : ''}`
      : null;

    return (
      <>
        {isPreview && !hideDebugLabels && blockFieldPath && (
          /* eslint-disable-next-line astro/jsx-a11y/anchor-is-valid */
          <a
            class="block-name-label"
            data-debug-edit-block
            data-debug-field-path={blockFieldPath}
            data-debug-block-name={blockName}
            target="_blank"
          >
            {blockName}
          </a>
        )}
        {/* @ts-expect-error - since block can be any block its type is conflated to `never`. */}
        <Block block={block} debugFieldPath={blockBasePath} hideDebugLabels={hideDebugLabels} />
      </>
    );
  })
}

