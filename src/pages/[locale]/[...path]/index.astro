---
import { getPageHref, formatBreadcrumb, type PageUrl } from '@lib/routing';
import {
  getParentPages,
} from '@lib/routing/page';
import type { SiteLocale } from '@lib/datocms/types';
import Layout from '@layouts/Default.astro';
import Blocks from '@blocks/Blocks.astro';
import PreviewModeSubscription from '@components/PreviewMode/PreviewModeSubscription.astro';
import { getCollection, getEntry } from '@lib/content';

export async function getStaticPaths() {
  // Fetch all locales by passing locale `null` and filter `undefined`.
  const pages = await getCollection('Pages', undefined, null);
  return pages.map(({ 
    data: page,
  }) => ({
    params: { locale: page.meta.locale, path: page.meta.path },
  }));
}

// Load as an entry so this route can also be a server route in preview mode.
// @see /docs/preview-mode.md
const { locale, path } = Astro.params;
const entry = await getEntry('Pages', path);
if (!entry) {
  return Astro.redirect('/404', 404);
}

const { data: page, subscription } = entry;

const breadcrumbs = [...getParentPages(page), page].map((page) =>
  formatBreadcrumb({
    text: page.title,
    href: getPageHref({ locale, record: page }),
  })
);
const pageUrls = (page._allSlugLocales || []).map(({ locale }) => ({
  locale: locale as SiteLocale,
  pathname: getPageHref({ locale: locale as SiteLocale, record: page }),
})) as PageUrl[];
---

<Layout
  breadcrumbs={breadcrumbs}
  pageUrls={pageUrls}
  seoMetaTags={page._seoMetaTags}
>
  <PreviewModeSubscription {...subscription} />
  <h1>{page.title}</h1>
  <Blocks blocks={page.bodyBlocks} />
</Layout>
