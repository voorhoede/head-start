---
import { datocmsCollection, datocmsRequest } from '@lib/datocms';
import { getPageHref, isServerRoute } from '@lib/routing/';
import {
  getPagePath,
  getPageSlugFromPath,
  getParentPages,
} from '@lib/routing/page';
import { 
  PageRoute as fragment, 
  type PageQuery, 
  type PageRouteFragment, 
  type SiteLocale 
} from '@lib/datocms/types';
import type { PageUrl } from '@lib/seo';
import Layout from '@layouts/Default.astro';
import Blocks from '@blocks/Blocks.astro';
import { formatBreadcrumb } from '@components/Breadcrumbs';
import PreviewModeSubscription from '@components/PreviewMode/PreviewModeSubscription.astro';
import query from './_index.query.graphql';

const prerender = false;

export async function getStaticPaths() {
  const pages = await datocmsCollection<PageRouteFragment>({
    collection: 'Pages',
    fragment,
  });
  return pages
    .filter(isServerRoute)
    .flatMap((page) => {
      const locales = page._allSlugLocales
        ?.map((slug) => slug.locale)
        .filter((locale) => !!locale);
      return locales?.map((locale) => {
        return { params: { locale, serverPath: getPagePath({ page, locale }) } };
      });
    });
}

type Params = {
  locale: SiteLocale;
  serverPath: string;
};

const { locale, serverPath } = Astro.params as Params;
const variables = { locale, slug: getPageSlugFromPath(serverPath) };
const { page } = await datocmsRequest<PageQuery, typeof prerender>({ query, variables });

if (!page) {
  return new Response(null, {
    status: 404,
    statusText: 'Not found'
  });
}

const breadcrumbs = [...getParentPages(page), page].map((page) =>
  formatBreadcrumb({
    text: page.title,
    href: getPageHref({ locale, record: page }),
  })
);
const pageUrls = (page._allSlugLocales || []).map(({ locale }) => ({
  locale: locale as SiteLocale,
  pathname: getPageHref({ locale: locale as SiteLocale, record: page }),
})) as PageUrl[];
---

<Layout
  breadcrumbs={breadcrumbs}
  pageUrls={pageUrls}
  seoMetaTags={page._seoMetaTags}
>
  <PreviewModeSubscription query={query} variables={variables} />
  <h1><mark>Server rendered</mark> {page.title}</h1>
  <Blocks blocks={page.bodyBlocks} />
</Layout>
