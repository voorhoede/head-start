---
import type { AppMenuFragment } from '@lib/datocms/types';
import { t } from '@lib/i18n';
import type { PageUrl } from '@lib/routing';
import AppLogo from '@components/AppLogo/AppLogo.astro';
import IconButton from '@components/IconButton/IconButton.astro';
import LocaleSelector from '@components/LocaleSelector/LocaleSelector.astro';
import SearchLink from '@components/SearchLink/SearchLink.astro';
import UnstyledList from '@components/UnstyledList/UnstyledList.astro';
import AppMenuItem from './AppMenuItem.astro';
import { getItemPopoverId } from './AppMenu';

export interface Props {
  items: AppMenuFragment['menuItems'];
  pageUrls: PageUrl[];
}
const { items, pageUrls } = Astro.props;
---

<app-menu>
  <nav class="main-menu" aria-labelledby="main-menu-title">
    <span id="main-menu-title" class="a11y-sr-only">{t('main_menu')}</span>
    <UnstyledList class:list="main-menu__list" data-menu-list>
      {
        items.map((item) => {
          return (
            <AppMenuItem
              item={item}
              class:list="main-menu__item"
              data-menu-item
            >
              {item.items?.length && (
                <ul
                  popover
                  id={getItemPopoverId(item.id)}
                  data-placement="bottom-start"
                >
                  {item.items?.map((subItem, index) => (
                    <AppMenuItem
                      item={subItem}
                      class:list="submenu__item"
                      data-submenu-item
                    >
                      {Array.isArray(subItem.items) &&
                        subItem.items.length > 0 && (
                        <button
                          type="button"
                          popovertarget={getItemPopoverId(
                            item.id,
                            `sub-${index}`,
                          )}
                        >
                            open
                        </button>
                      )}
                      {Array.isArray(subItem.items) &&
                        subItem.items.length > 0 && (
                        <ul
                          popover
                          id={getItemPopoverId(item.id, `sub-${index}`)}
                          data-placement="right-start"
                        >
                          {subItem.items?.map((subSubItem) => (
                            <AppMenuItem
                              item={subSubItem}
                              data-submenu-item
                            />
                          ))}
                        </ul>
                      )}
                    </AppMenuItem>
                  ))}
                </ul>
              )}
            </AppMenuItem>
          );
        })
      }
      <li class="main-menu__item main-menu__item--last" data-menu-item>
        <SearchLink />
      </li>
    </UnstyledList>
  </nav>
  <LocaleSelector pageUrls={pageUrls} />
  <IconButton
    icon="menu"
    label={t('open_menu')}
    class:list="main-menu__button"
    data-menu-button
    hidden
  />

  <dialog data-menu-dialog>
    <AppLogo />
    <nav aria-labelledby="menu-dialog-title">
      <span id="menu-dialog-title" class="a11y-sr-only">{t('main_menu')}</span>
      <UnstyledList class="dialog__list">
        {
          items.map((item) => {
            return (
              <AppMenuItem item={item} class:list="dialog__item">
                {item.items?.length > 0 && (
                  <ul>
                    {item.items?.map((subItem) => (
                      <AppMenuItem
                        item={subItem}
                        class:list="submenu__item"
                        data-submenu-item
                      >
                        {subItem.items?.length > 0 && (
                          <ul>
                            {subItem.items?.map((subSubItem) => (
                              <AppMenuItem
                                item={subSubItem}
                                data-submenu-item
                              />
                            ))}
                          </ul>
                        )}
                      </AppMenuItem>
                    ))}
                  </ul>
                )}
              </AppMenuItem>
            );
          })
        }
        <li><SearchLink /></li>
      </UnstyledList>
    </nav>
    <LocaleSelector pageUrls={pageUrls} />
    <IconButton icon="close" label={t('close_menu')} data-menu-close />
  </dialog>
</app-menu>

<script src="./AppMenu.client.ts"></script>

<style>
  app-menu {
    display: flex;
    align-items: center;
    flex-grow: 1;
    gap: 20px;
  }

  app-menu a {
    margin: 5px;
  }

  .main-menu {
    flex-grow: 1;
    white-space: nowrap;
    overflow: hidden;
  }

  .main-menu__list {
    display: flex;
    gap: 10px;
  }

  .main-menu__item--last {
    margin-inline-start: auto;
  }

  .main-menu__button {
    display: none;
  }

  app-menu.is-compact .main-menu__button {
    display: block;
  }

  app-menu.is-compact .main-menu__list {
    display: none;
  }

  [popover] {
    margin: 0;
    inset-inline-start: 0;
  }

  [popover]::before {
    content: '';
    position: absolute;
    top: -10px;
    left: 0;
    right: 0;
    height: 10px;
  }

  [popover][data-placement='right-start'] {
    margin-left: 5px;
  }

  dialog {
    height: 100vh;
    max-height: 100vh; /* overwrite default */
    width: 300px;
    max-width: 100vw;
    background-color: white;
    color: black;
    border: none;
    margin-block: 0;
    margin-inline-start: auto;
    margin-inline-end: 0;
    padding: 20px;
  }

  dialog::backdrop {
    background-color: rgba(0, 0, 0, 0.8);
  }

  .dialog__list {
    margin-block: 30px;
  }
  .dialog__item {
    margin-block: 20px;
  }
  dialog button {
    position: absolute;
    top: 20px;
    right: 20px;
  }
</style>
